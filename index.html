<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ヒロアカURコスチューム検索</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      background-color: #f9f9f9;
    }
    select, button {
      padding: 0.5rem;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    label {
      margin-right: 1rem;
    }
    #results li {
      background: white;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
    }
    .skill-container {
      display: flex;
      gap: 1.5rem;
      margin-top: 0.5rem;
    }
    .skill-column {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 100px;
    }
    .skill-box {
      width: 30px;
      height: 30px;
      border: 2px solid;
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 14px;
      color: black;
    }
    /* 色ごとの枠線カラー */
    .color-赤 { border-color: red; }
    .color-青 { border-color: blue; }
    .color-黄 { border-color: goldenrod; }
    .color-緑 { border-color: green; }
    .color-紫 { border-color: purple; }
  </style>
</head>
<body>

  <h2>キャラクターを選択</h2>
  <select id="company" onchange="checkForm()">
    <option value="">--選択--</option>
  </select>

  <h2>色を選択（0〜2つ）</h2>
  <div id="colors">
    <label><input type="checkbox" value="赤" onchange="limitColors()"> 赤</label>
    <label><input type="checkbox" value="青" onchange="limitColors()"> 青</label>
    <label><input type="checkbox" value="黄" onchange="limitColors()"> 黄</label>
    <label><input type="checkbox" value="緑" onchange="limitColors()"> 緑</label>
    <label><input type="checkbox" value="紫" onchange="limitColors()"> 紫</label>
  </div>

  <p id="error-message" style="color:red;"></p>
  <button id="search-btn" onclick="search()" disabled>検索</button>

  <p id="loading-message" style="color:blue; font-weight:bold; display:none;">検索中...</p>
  <p id="result-count" style="font-weight:bold;"></p>

  <ul id="results"></ul>

<script>
const gasUrl = 'https://script.google.com/macros/s/AKfycbyH3vZTg7TtYaU8VR_L4s0eE6dtws0OiwzczELhoEIGarMBtfe3eLNEYYBerrDSRx5k/exec'; // GAS URLに置き換えてください

document.addEventListener('DOMContentLoaded', async () => {
  const res = await fetch(`${gasUrl}?mode=companies`);
  const companies = await res.json();
  const select = document.getElementById('company');
  companies.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });
});

function limitColors() {
  const checkboxes = document.querySelectorAll('#colors input[type="checkbox"]');
  const checked = Array.from(checkboxes).filter(cb => cb.checked);
  const btn = document.getElementById('search-btn');
  const error = document.getElementById('error-message');
  const hasCompany = document.getElementById('company').value !== "";

  if (!hasCompany || checked.length > 2) {
    error.textContent = 'キャラクターを選び、色は最大2つまでにしてください';
    btn.disabled = true;
  } else {
    error.textContent = '';
    btn.disabled = false;
  }

  checkboxes.forEach(cb => cb.disabled = !cb.checked && checked.length >= 2);
}

function checkForm() { limitColors(); }

function createSkillBox(text, color) {
  const div = document.createElement('div');
  div.className = 'skill-box color-' + color;
  div.textContent = text;
  return div;
}

async function search() {
  const company = document.getElementById('company').value;
  const colors = Array.from(document.querySelectorAll('#colors input[type="checkbox"]:checked')).map(cb => cb.value);
  const params = new URLSearchParams();
  params.append('company', company);
  colors.forEach(c => params.append('colors', c));

  document.getElementById('loading-message').style.display = 'block';
  document.getElementById('result-count').textContent = '';
  document.getElementById('results').innerHTML = '';

  try {
    const res = await fetch(`${gasUrl}?` + params.toString());
    const data = await res.json();

    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('result-count').textContent = `該当件数: ${data.length} 件`;

    const list = document.getElementById('results');
    if (data.length === 0) {
      list.innerHTML = '<li>該当するコスチュームが見つかりませんでした。</li>';
      return;
    }

    data.forEach(item => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>コスチューム：${item.costume}</strong><br>
        キャラクター：${item.character}<br>
        スペシャルチューニングスキル1：
      `;

      // スペシャルチューニングスキル（メイン色・サブ色）表示
      const mainColorDiv = createSkillBox('H', item.main_color);
      const subColorDiv = createSkillBox('V', item.sub_color);

      // コンテナを作って追加
      const spContainer = document.createElement('div');
      spContainer.className = 'skill-container';
      spContainer.appendChild(mainColorDiv);
      spContainer.appendChild(subColorDiv);

      li.appendChild(spContainer);

      // チューニングスキル1～10を2列に分けて表示
      const tuningContainer = document.createElement('div');
      tuningContainer.className = 'skill-container';

      const col1 = document.createElement('div');
      col1.className = 'skill-column';
      const col2 = document.createElement('div');
      col2.className = 'skill-column';

      item.details.forEach((skill, i) => {
        // 色とH/Vの切り分け
        let color = 'gray'; // デフォルト枠色（グレー）
        let text = '';
        if (skill) {
          // 例：赤H、黄V、青 など
          const m = skill.match(/^([赤青黄緑紫]+)([HV])?$/);
          if (m) {
            color = {
              '赤': '赤',
              '青': '青',
              '黄': '黄',
              '緑': '緑',
              '紫': '紫',
            }[m[1]] || 'gray';
            text = m[2] || '';
          } else {
            text = skill;
          }
        }
        const box = document.createElement('div');
        box.className = 'skill-box';
        box.style.borderColor = color === 'gray' ? '#ccc' : {
          '赤': 'red',
          '青': 'blue',
          '黄': 'goldenrod',
          '緑': 'green',
          '紫': 'purple',
        }[color] || '#ccc';
        box.textContent = text;

        if (i < 5) {
          col1.appendChild(box);
        } else {
          col2.appendChild(box);
        }
      });

      tuningContainer.appendChild(col1);
      tuningContainer.appendChild(col2);

      li.appendChild(document.createElement('br'));
      li.appendChild(document.createTextNode('チューニングスキル'));
      li.appendChild(tuningContainer);

      list.appendChild(li);
    });

  } catch (err) {
    document.getElementById('loading-message').style.display = 'none';
    alert('検索中にエラーが発生しました');
    console.error(err);
  }
}
</script>

</body>
</html>
